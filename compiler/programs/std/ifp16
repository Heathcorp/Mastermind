// #include <u8>
// #include <i8>
#include <u16>

struct ifp16 {
  struct i8 int;
  cell frac;
}

// struct ifp16 {
//   cell sign_neg;
//   cell int;
//   cell frac;
// }
// (+/-)(int + frac * 2^-8)

fn _1(struct ifp16 n)             {n.int.n = 1;    n.frac = 0;}
fn _2(struct ifp16 n)             {n.int.n = 2;    n.frac = 0;}
fn _4(struct ifp16 n)             {n.int.n = 4;    n.frac = 0;}
fn _8(struct ifp16 n)             {n.int.n = 8;    n.frac = 0;}
fn _16(struct ifp16 n)            {n.int.n = 16;    n.frac = 0;}
fn _32(struct ifp16 n)            {n.int.n = 32;    n.frac = 0;}
fn _64(struct ifp16 n)            {n.int.n = 64;    n.frac = 0;}
fn _127(struct ifp16 n)           {n.int.n = 127;  n.frac = 0;}
fn _127p99609375(struct ifp16 n)  {n.int.n = 127;  n.frac = 255;}
fn __128(struct ifp16 n)          {n.int.n = -128; n.frac = 0;}
fn _0p99609375(struct ifp16 n)    {n.int.n = 0;    n.frac = 255;}
fn _0p5(struct ifp16 n)           {n.int.n = 0;    n.frac = 128;}
fn _0p25(struct ifp16 n)          {n.int.n = 0;    n.frac = 64;}
fn _0p125(struct ifp16 n)         {n.int.n = 0;    n.frac = 32;}
fn _0p0625(struct ifp16 n)        {n.int.n = 0;    n.frac = 16;}
fn _0p03125(struct ifp16 n)       {n.int.n = 0;    n.frac = 8;}
fn _0p015625(struct ifp16 n)      {n.int.n = 0;    n.frac = 4;}
fn _0p0078125(struct ifp16 n)     {n.int.n = 0;    n.frac = 2;}
fn _0p00390625(struct ifp16 n)    {n.int.n = 0;    n.frac = 1;}
fn __0p00390625(struct ifp16 n)   {n.int.n = -1;   n.frac = 255;}
fn __0p0078125(struct ifp16 n)    {n.int.n = -1;   n.frac = 254;}
fn __0p015625(struct ifp16 n)     {n.int.n = -1;   n.frac = 252;}
fn __0p03125(struct ifp16 n)      {n.int.n = -1;   n.frac = 248;}
fn __0p0625(struct ifp16 n)       {n.int.n = -1;   n.frac = 240;}
fn __0p125(struct ifp16 n)        {n.int.n = -1;   n.frac = 224;}
fn __0p25(struct ifp16 n)         {n.int.n = -1;   n.frac = 192;}
fn __0p5(struct ifp16 n)          {n.int.n = -1;   n.frac = 128;}
fn __0p99609375(struct ifp16 n)   {n.int.n = -1;   n.frac = 1;}
fn _1p5(struct ifp16 n)           {n.int.n = 1;    n.frac = 128;}
fn _2p5(struct ifp16 n)           {n.int.n = 2;    n.frac = 128;}
fn _7p75(struct ifp16 n)          {n.int.n = 2;    n.frac = 192;}
fn __1p5(struct ifp16 n)          {n.int.n = -2;   n.frac = 128;}
fn __2p5(struct ifp16 n)          {n.int.n = -3;   n.frac = 128;}
fn __6p25(struct ifp16 n)         {n.int.n = -7;   n.frac = 192;}
fn _99p99609375(struct ifp16 n)   {n.int.n = 99;   n.frac = 255;}
fn __99p99609375(struct ifp16 n)  {n.int.n = -100;  n.frac = 1;}
fn _127p12890625(struct ifp16 n)  {n.int.n = 127;  n.frac = 33;}
fn __127p12890625(struct ifp16 n) {n.int.n = -128;  n.frac = 223;}

fn MIN(struct ifp16 n) {__128(n);}
fn MAX(struct ifp16 n) {_127p99609375(n);}
fn EPSILON(struct ifp16 n) {_0p00390625(n);}
fn _EPSILON(struct ifp16 n) {__0p00390625(n);}

/// add-assign two ifp16 numbers
fn add(struct ifp16 self, struct ifp16 other) {
  add(self.int, other.int);
  copy other.frac {
    self.frac += 1;
    inc(self.int);
    if self.frac {
      dec(self.int);
    }
  }
}

///
fn mult(struct ifp16 self, cell other) {

}
fn mult(struct ifp16 self, struct i8 other) {

}
fn mult(struct ifp16 self, struct ifp16 other) {

}

/// 1/n
fn recip(struct ifp16 self) {

}

/// 
fn div(struct ifp16 self, struct ifp16 other) {

}

/// read an fp16 from stdin, wraps integer digits, truncates fractional part
fn read(struct ifp16 self) {
  cell sign_neg = false;
  cell digit;
  input digit;
  if not digit - '-' {
    sign_neg = true;
    input digit;
  }
  // input the abs integer amount
  cell abs_int;
  {
    cell iterating = true;
    while iterating {
      if not digit - '.' {
        iterating = false;
      }
      if not digit - '\n' {
        iterating = false;
      }
      if iterating {
        // shift digits (times by 10) and add the new digit
        mult_10(abs_int);
        abs_int += digit - '0';
    
        input digit;
      }
    }
  }

  // read the decimal part if needed
  if not digit - '.' {
    // input a number up to 2 digits, count the leading zeros
    // we input directly into the most-signifant byte of a u16
    //  so it is automatically x256
    struct u16 n;
    {
      cell frac_digit_count;
      {
        cell iterating = 2; // limit 2 digits for fp16
        drain iterating {
          input digit;
          digit -= '\n';
          if not digit {
            iterating = false;
          } else {
            digit += '\n';
            digit -= '0';
            // another digit
            frac_digit_count += 1;
    
            mult_10(n.n1);
            n.n1 += digit;
          }
        }
      }
  
      // we have multiplied our integer by 256
      // divide by 10^frac_digit_count
      drain frac_digit_count {
        div_10(n);
      }
    }

    self.frac = n.n0;
  }
}

/// format and print to 2 decimal places
fn print(struct ifp16 self) {
  cell int_abs;
  cell neg;
  to_u8(self.int, int_abs, neg);

  // convert from integer to decimal digits * 2^-8
  // (frac * 25) >> 6
  // (frac * 10 * 10) >> 8
  struct u16 n;
  n.n0 = self.frac;
  if neg {
    // minus sign
    output '-';
    n.n0 = -self.frac;
    if self.frac {
      // correct for sign stuff
      int_abs -= 1;
    }
  }
  {
    cell c = 100;
    mult_n_d(n, c);
  }
  // {
  //   // round?
  //   cell c = 7;
  //   tshift_r(n.n0, 7);
  //   drain n.n0 into n.n1;
  // }

  // integer part
  print(int_abs);
  // decimal point
  output '.';
  print(n.n1);
}

/// print a debug representation of an ifp16
fn debug(struct ifp16 self) {
  // 11111111.11111111
  debug(self.int.n);
  output '.';
  debug(self.frac);
}

// debug/test code:
struct ifp16 h;
read(h);
print(h);


// struct ifp16 a;
// struct ifp16 e; EPSILON(e);
// struct ifp16 _e; _EPSILON(_e);
// output "e = "; print(e); output " ("; debug(e); output ")\n";
// _0p99609375(a); print(a); output " ("; debug(a); output ")\n";
// add(a, e); print(a); output " ("; debug(a); output ")\n";
// __128(a); print(a); output " ("; debug(a); output ")\n";
// _64(a); print(a); output " ("; debug(a); output ")\n";
// _32(a); print(a); output " ("; debug(a); output ")\n";
// _16(a); print(a); output " ("; debug(a); output ")\n";
// _8(a); print(a); output " ("; debug(a); output ")\n";
// _4(a); print(a); output " ("; debug(a); output ")\n";
// _2(a); print(a); output " ("; debug(a); output ")\n";
// _1(a); print(a); output " ("; debug(a); output ")\n";
// _0p5(a); print(a); output " ("; debug(a); output ")\n";
// _0p25(a); print(a); output " ("; debug(a); output ")\n";
// _0p125(a); print(a); output " ("; debug(a); output ")\n";
// _0p0625(a); print(a); output " ("; debug(a); output ")\n";
// _0p03125(a); print(a); output " ("; debug(a); output ")\n";
// _0p015625(a); print(a); output " ("; debug(a); output ")\n";
// _0p0078125(a); print(a); output " ("; debug(a); output ")\n";
// _0p00390625(a); print(a); output " ("; debug(a); output ")\n";
// _1p5(a); print(a); output " ("; debug(a); output ")\n";
// __0p5(a); print(a); output " ("; debug(a); output ")\n";
// __0p25(a); print(a); output " ("; debug(a); output ")\n";
// __6p25(a); print(a); output " ("; debug(a); output ")\n";
// _99p99609375(a); print(a); output " ("; debug(a); output ")\n";
// add(a, e); print(a); output " ("; debug(a); output ")\n";
// add(a, e); print(a); output " ("; debug(a); output ")\n";
// __99p99609375(a); print(a); output " ("; debug(a); output ")\n";
// add(a, _e); print(a); output " ("; debug(a); output ")\n";
// add(a, _e); print(a); output " ("; debug(a); output ")\n";
// add(a, _e); print(a); output " ("; debug(a); output ")\n";
// add(a, e); print(a); output " ("; debug(a); output ")\n";
// add(a, e); print(a); output " ("; debug(a); output ")\n";
// add(a, e); print(a); output " ("; debug(a); output ")\n";
// add(a, e); print(a); output " ("; debug(a); output ")\n";
// add(a, e); print(a); output " ("; debug(a); output ")\n";
// add(a, e); print(a); output " ("; debug(a); output ")\n";
// add(a, e); print(a); output " ("; debug(a); output ")\n";
// add(a, e); print(a); output " ("; debug(a); output ")\n";
// add(a, e); print(a); output " ("; debug(a); output ")\n";
// _127p12890625(a); print(a); output " ("; debug(a); output ")\n";
// __127p12890625(a); print(a); output " ("; debug(a); output ")\n";
// MAX(a); print(a); output " ("; debug(a); output ")\n";
// add(a, e); print(a); output " ("; debug(a); output ")\n";

